<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>データ管理</title>
  <style>
    body {
      font-family: 'Helvetica', 'Segoe UI', 'Meiryo', 'Arial', sans-serif;
      background-color: #e3f2fd;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      background: #fff;
      padding: 32px 24px;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.10);
      width: 95vw;
      max-width: 480px;
      margin: 40px auto;
      font-family: inherit;
    }

    h2,
    h3 {
      text-align: center;
      color: #1976d2;
      font-weight: 600;
      margin-bottom: 18px;
      font-family: inherit;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #90caf9;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      font-family: inherit;
      background: #e3f2fd;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: #1976d2;
      outline: none;
    }

    button {
      width: 100%;
      background-color: #42a5f5;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      transition: background 0.2s;
    }

    button:hover {
      background-color: #1976d2;
    }

    #loginResult {
      color: #1976d2;
      text-align: center;
      margin-top: 10px;
      font-family: inherit;
    }

    #mainContent {
      max-width: 900px;
      margin: 40px auto;
      padding: 32px 24px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.10);
      font-family: inherit;
      position: relative;
    }

    .settings-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #1976d2;
      color: #fff;
      border: none;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .settings-btn:hover {
      background-color: #42a5f5;
    }

    #settingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(33, 150, 243, 0.08);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #settingsModal .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(33, 150, 243, 0.18);
      min-width: 280px;
      max-width: 90vw;
      text-align: center;
      font-family: inherit;
    }

    #logoutBtn {
      background-color: #ff7043;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      transition: background 0.2s;
      margin-bottom: 12px;
      width: 100%;
    }

    #logoutBtn:hover {
      background-color: #e64a19;
    }

    .tab {
      display: inline-block;
      padding: 10px 24px;
      cursor: pointer;
      background: #e3f2fd;
      margin-right: 5px;
      border-radius: 8px 8px 0 0;
      font-size: 17px;
      font-family: inherit;
      font-weight: 500;
      color: #1976d2;
      border: none;
      transition: background 0.2s, color 0.2s;
    }

    .tab.active {
      background: #1976d2;
      color: #fff;
      border-bottom: 2px solid #fff;
    }

    .tab-content {
      display: none;
      border: 1px solid #90caf9;
      padding: 18px;
      background: #e3f2fd;
      border-radius: 0 0 12px 12px;
      font-family: inherit;
      margin-bottom: 24px;
    }

    .tab-content.active {
      display: block;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      font-family: inherit;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid #90caf9;
      padding: 10px;
      text-align: center;
      font-size: 16px;
      font-family: inherit;
    }

    th {
      background: #bbdefb;
      color: #1976d2;
      font-weight: 600;
    }

    input[type="date"],
    input[type="text"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #90caf9;
      margin-right: 8px;
      font-family: inherit;
      font-size: 15px;
      background: #fff;
      transition: border-color 0.2s;
    }

    input[type="date"]:focus,
    input[type="text"]:focus {
      border-color: #1976d2;
      outline: none;
    }

    @media (max-width: 600px) {
      #mainContent,
      .container {
        padding: 12px 4px;
        max-width: 99vw;
      }

      th,
      td {
        font-size: 13px;
        padding: 6px;
      }

      .tab {
        padding: 8px 12px;
        font-size: 15px;
      }

      .settings-btn {
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container" id="loginScreen">
    <h2>先生ログイン</h2>
    <input type="text" id="teacherUsername" placeholder="先生ユーザー名" />
    <input type="password" id="teacherPassword" placeholder="パスワード" />
    <button onclick="teacherLogin()">ログイン</button>
    <h3>先生新規登録</h3>
    <input type="text" id="newTeacherUsername" placeholder="先生ユーザー名" />
    <input type="password" id="newTeacherPassword" placeholder="パスワード" />
    <button onclick="teacherRegister()">登録</button>
    <p id="loginResult"></p>
  </div>

  <div id="mainContent" style="display:none;">
    <button class="settings-btn" onclick="openSettings()" title="設定">&#9881;</button>
    <div style="margin-bottom: 18px;">
      <span class="tab active" id="mainTab" onclick="showTab('main')">生徒データ</span>
      <span class="tab" id="lateTab" onclick="showTab('late')">遅刻データ</span>
    </div>
    <div id="main" class="tab-content active">
      <h3 style="color:#1976d2;">生徒データ</h3>
      <input type="date" id="mainDate" placeholder="date">
      <input type="text" id="mainName" placeholder="name">
      <button onclick="mainSearch()" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 16px;">検索</button>
      <table id="mainTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody>
          <!-- データがここに入る -->
        </tbody>
      </table>
    </div>
    <div id="late" class="tab-content">
      <h3 style="color:#1976d2;">遅刻データ</h3>
      <input type="date" id="lateDate" placeholder="date">
      <input type="text" id="lateName" placeholder="name">
      <button onclick="lateSearch()" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 16px;">検索</button>
      <table id="lateTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Name</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          <!-- データがここに入る -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="settingsModal">
    <div class="modal-content">
      <h3>設定</h3>
      <button id="logoutBtn" onclick="teacherLogout()">ログアウト</button>
      <button onclick="closeSettings()">閉じる</button>
    </div>
  </div>

  <script>
    const baserow = {
      url: "https://api.baserow.io/api/database/rows/table/685053/",
      lateurl: "https://api.baserow.io/api/database/rows/table/691308/",
      token: "Token z8Du55WVQi6wmFT3Ta6diQUSUxCqx8WR"
    }

    // 先生用ユーザー管理
    function getTeachers() {
      return JSON.parse(localStorage.getItem("TEACHERS") || "{}");
    }

    function saveTeachers(teachers) {
      localStorage.setItem("TEACHERS", JSON.stringify(teachers));
    }

    async function hashPassword(password) {
      const enc = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function teacherRegister() {
      const newTeacher = document.getElementById("newTeacherUsername").value;
      const newPass = document.getElementById("newTeacherPassword").value;
      const teachers = getTeachers();
      if (teachers[newTeacher]) {
        document.getElementById("loginResult").textContent = "すでに登録されています";
        return;
      }
      const hashed = await hashPassword(newPass);
      teachers[newTeacher] = hashed;
      saveTeachers(teachers);
      document.getElementById("loginResult").textContent = "先生登録完了";
    }

    async function teacherLogin() {
      const username = document.getElementById("teacherUsername").value;
      const password = document.getElementById("teacherPassword").value;
      const teachers = getTeachers();
      const hashed = await hashPassword(password);
      if (teachers[username] && teachers[username] === hashed) {
        localStorage.setItem("loggedInTeacher", username);
        showMainContent();
      } else {
        document.getElementById("loginResult").textContent = "ユーザー名またはパスワードが違います";
      }
    }

    function teacherLogout() {
      if (confirm("本当にログアウトしますか？")) {
        localStorage.removeItem("loggedInTeacher");
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("settingsModal").style.display = "none";
        document.getElementById("loginScreen").style.display = "block";
      }
    }

    function showMainContent() {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      fetchAndDisplay(baserow.url, 'mainTable');
      fetchAndDisplay(baserow.lateurl, 'lateTable');
    }

    function showTab(tab) {
      document.getElementById('main').classList.remove('active');
      document.getElementById('late').classList.remove('active');
      document.getElementById('mainTab').classList.remove('active');
      document.getElementById('lateTab').classList.remove('active');
      document.getElementById(tab).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
    }

    async function fetchAndDisplay(url, tableId, date = '', name = '') {
      let query = '?user_field_names=true';
      if (date) {
        query += `&filter__Date__equal=${date}`;
      }
      if (name) {
        query += `&filter__Name__equal=${name}`;
      }
      let res = await fetch(url + query, {
        method: 'GET',
        headers: {
          'Authorization': baserow.token,
          'Content-Type': 'application/json',
        },
      });
      let json = await res.json();
      let rows = json.results || [];
      let tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      // 表のカラムに合わせて表示
      if (tableId === 'mainTable') {
        rows.forEach(row => {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.Date || ''}</td><td>${row.Name || ''}</td>`;
          tbody.appendChild(tr);
        });
      } else if (tableId === 'lateTable') {
        rows.forEach(row => {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.Date || ''}</td><td>${row.Name || ''}</td><td>${row.Reason || ''}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    // 検索ボタン用
    async function mainSearch() {
      const date = document.getElementById('mainDate').value;
      const name = document.getElementById('mainName').value;
      await fetchAndDisplay(
        baserow.url,
        'mainTable',
        date ? new Date(date).toLocaleDateString() : '',
        name
      );
    }

    async function lateSearch() {
      const date = document.getElementById('lateDate').value;
      const name = document.getElementById('lateName').value;
      await fetchAndDisplay(
        baserow.lateurl,
        'lateTable',
        date ? new Date(date).toLocaleDateString() : '',
        name
      );
    }

    // 設定モーダル表示・非表示
    function openSettings() {
      document.getElementById("settingsModal").style.display = "flex";
    }

    function closeSettings() {
      document.getElementById("settingsModal").style.display = "none";
    }

    // ページロード時ログイン状態確認
    window.onload = function() {
      const teacher = localStorage.getItem("loggedInTeacher");
      if (teacher) {
        showMainContent();
      }
    }
  </script>
</body>

</html>