<!DOCTYPE html>
<html lang="ja">

<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>データ管理</title>
  <style>
    body {
      font-family: 'Helvetica', 'Segoe UI', 'Meiryo', 'Arial', sans-serif;
      background-color: #e3f2fd;
      margin: 0;
      padding: 0;
      min-height: 100vh;
      display: flex;
      justify-content: center;
      align-items: flex-start;
    }

    .container {
      background: #fff;
      padding: 32px 24px;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.10);
      width: 95vw;
      max-width: 480px;
      margin: 40px auto;
      font-family: inherit;
    }

    h2,
    h3 {
      text-align: center;
      color: #1976d2;
      font-weight: 600;
      margin-bottom: 18px;
      font-family: inherit;
    }

    input {
      width: 100%;
      padding: 10px;
      margin: 8px 0;
      border: 1px solid #90caf9;
      border-radius: 8px;
      box-sizing: border-box;
      font-size: 16px;
      font-family: inherit;
      background: #e3f2fd;
      transition: border-color 0.2s;
    }

    input:focus {
      border-color: #1976d2;
      outline: none;
    }

    button {
      width: 100%;
      background-color: #42a5f5;
      color: white;
      padding: 12px;
      border: none;
      border-radius: 8px;
      margin: 10px 0;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      transition: background 0.2s;
    }

    button:hover {
      background-color: #1976d2;
    }

    #loginResult {
      color: #1976d2;
      text-align: center;
      margin-top: 10px;
      font-family: inherit;
    }

    #mainContent {
      max-width: 900px;
      margin: 40px auto;
      padding: 32px 24px;
      background: #fff;
      border-radius: 14px;
      box-shadow: 0 4px 16px rgba(33, 150, 243, 0.10);
      font-family: inherit;
      position: relative;
    }

    .settings-btn {
      position: absolute;
      top: 24px;
      right: 24px;
      width: 44px;
      height: 44px;
      border-radius: 50%;
      background-color: #1976d2;
      color: #fff;
      border: none;
      font-size: 22px;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      display: flex;
      align-items: center;
      justify-content: center;
      transition: background 0.2s;
    }

    .settings-btn:hover {
      background-color: #42a5f5;
    }

    #settingsModal {
      display: none;
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(33, 150, 243, 0.08);
      z-index: 1000;
      justify-content: center;
      align-items: center;
    }

    #settingsModal .modal-content {
      background: #fff;
      padding: 32px 24px;
      border-radius: 14px;
      box-shadow: 0 4px 24px rgba(33, 150, 243, 0.18);
      min-width: 280px;
      max-width: 90vw;
      text-align: center;
      font-family: inherit;
    }

    #logoutBtn {
      background-color: #ff7043;
      color: #fff;
      border: none;
      border-radius: 8px;
      padding: 12px 0;
      cursor: pointer;
      font-size: 16px;
      font-family: inherit;
      font-weight: 500;
      box-shadow: 0 2px 8px rgba(33, 150, 243, 0.08);
      transition: background 0.2s;
      margin-bottom: 12px;
      width: 100%;
    }

    #logoutBtn:hover {
      background-color: #e64a19;
    }

    .tab {
      display: inline-block;
      padding: 10px 24px;
      cursor: pointer;
      background: #e3f2fd;
      margin-right: 5px;
      border-radius: 8px 8px 0 0;
      font-size: 17px;
      font-family: inherit;
      font-weight: 500;
      color: #1976d2;
      border: none;
      transition: background 0.2s, color 0.2s;
    }

    .tab.active {
      background: #1976d2;
      color: #fff;
      border-bottom: 2px solid #fff;
    }

    .tab-content {
      display: none;
      border: 1px solid #90caf9;
      padding: 18px;
      background: #e3f2fd;
      border-radius: 0 0 12px 12px;
      font-family: inherit;
      margin-bottom: 24px;
    }

    .tab-content.active {
      display: block;
    }

    table {
      border-collapse: collapse;
      width: 100%;
      background: #fff;
      border-radius: 8px;
      overflow: hidden;
      font-family: inherit;
      margin-top: 12px;
    }

    th,
    td {
      border: 1px solid #90caf9;
      padding: 10px;
      text-align: center;
      font-size: 16px;
      font-family: inherit;
    }

    th {
      background: #bbdefb;
      color: #1976d2;
      font-weight: 600;
    }

    input[type="date"],
    input[type="text"] {
      padding: 8px;
      border-radius: 6px;
      border: 1px solid #90caf9;
      margin-right: 8px;
      font-family: inherit;
      font-size: 15px;
      background: #fff;
      transition: border-color 0.2s;
    }

    input[type="date"]:focus,
    input[type="text"]:focus {
      border-color: #1976d2;
      outline: none;
    }

    @media (max-width: 600px) {
      #mainContent,
      .container {
        padding: 12px 4px;
        max-width: 99vw;
      }

      th,
      td {
        font-size: 13px;
        padding: 6px;
      }

      .tab {
        padding: 8px 12px;
        font-size: 15px;
      }

      .settings-btn {
        top: 12px;
        right: 12px;
        width: 36px;
        height: 36px;
        font-size: 18px;
      }
    }
  </style>
</head>

<body>
  <div class="container" id="loginScreen">
    <h2>先生ログイン</h2>
    <input type="text" id="teacherUsername" placeholder="先生ユーザー名" />
    <input type="password" id="teacherPassword" placeholder="パスワード" />
    <button onclick="teacherLogin()">ログイン</button>
    <h3>先生新規登録</h3>
    <input type="text" id="newTeacherUsername" placeholder="先生ユーザー名" />
    <input type="password" id="newTeacherPassword" placeholder="パスワード" />
    <button onclick="teacherRegister()">登録</button>
    <p id="loginResult"></p>
  </div>

  <div id="mainContent" style="display:none;">
    <button class="settings-btn" onclick="openSettings()" title="設定">&#9881;</button>
    <div id="loggedInTeacherDisplay" style="text-align:center; color:#1976d2; font-size:18px; font-weight:600; margin-bottom:10px;"></div>
    <div style="margin-bottom: 18px;">
      <span class="tab active" id="mainTab" onclick="showTab('main')">生徒データ</span>
      <span class="tab" id="lateTab" onclick="showTab('late')">遅刻データ</span>
      <span class="tab" id="approveTab" onclick="showTab('approve')">承認</span>
      <span class="tab" id="absentTab" onclick="showTab('absent')">欠席</span>
    </div>
    <div id="main" class="tab-content active">
      <h3 style="color:#1976d2;">生徒データ</h3>
      <input type="date" id="mainDate" placeholder="date">
      <input type="text" id="mainName" placeholder="name">
      <button onclick="mainSearch()" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 16px;">検索</button>
      <table id="mainTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Number</th>
            <th>Name</th>
          </tr>
        </thead>
        <tbody>
          <!-- データがここに入る -->
        </tbody>
      </table>
    </div>
    <div id="late" class="tab-content">
      <h3 style="color:#1976d2;">遅刻データ</h3>
      <input type="date" id="lateDate" placeholder="date">
      <input type="text" id="lateName" placeholder="name">
      <button onclick="lateSearch()" style="background:#1976d2;color:#fff;border:none;border-radius:6px;padding:8px 16px;">検索</button>
      <table id="lateTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Number</th>
            <th>Name</th>
            <th>Reason</th>
          </tr>
        </thead>
        <tbody>
          <!-- データがここに入る -->
        </tbody>
      </table>
    </div>

    <div id="approve" class="tab-content">
      <h3 style="color:#1976d2;">承認テンプレート一覧</h3>
      <p style="text-align:center; margin-bottom:8px;"><button onclick="refreshApprove()" style="width:auto; padding:8px 14px; border-radius:6px; background:#1976d2; color:#fff; border:none;">更新</button></p>
      <table id="approveTable">
        <thead>
          <!-- 動的に作成 -->
        </thead>
        <tbody>
          <!-- テンプレート行が入る -->
        </tbody>
      </table>
    </div>
    <div id="absent" class="tab-content">
      <h3 style="color:#1976d2;">欠席一覧</h3>
      <table id="studentTable">
        <thead>
          <tr>
            <th>Number</th>
            <th>Student</th>
          </tr>
        </thead>
        <tbody>
          <!-- studenturl のデータ -->
        </tbody>
      </table>
    </div>
  </div>

  <div id="settingsModal">
    <div class="modal-content">
      <h3>設定</h3>
      <button id="logoutBtn" onclick="teacherLogout()">ログアウト</button>
      <button onclick="closeSettings()">閉じる</button>
    </div>
  </div>

  <script>
    const baserow = {
      url: "https://api.baserow.io/api/database/rows/table/685053/",
      lateurl: "https://api.baserow.io/api/database/rows/table/691308/",
      templateurl: "https://api.baserow.io/api/database/rows/table/709073/",
      studenturl: "https://api.baserow.io/api/database/rows/table/709102/",
      token: "Token z8Du55WVQi6wmFT3Ta6diQUSUxCqx8WR"
    }

    // 先生用ユーザー管理
    function getTeachers() {
      return JSON.parse(localStorage.getItem("TEACHERS") || "{}");
    }

    function saveTeachers(teachers) {
      localStorage.setItem("TEACHERS", JSON.stringify(teachers));
    }

    async function hashPassword(password) {
      const enc = new TextEncoder().encode(password);
      const hashBuffer = await crypto.subtle.digest("SHA-256", enc);
      return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, "0")).join("");
    }

    async function teacherRegister() {
      const newTeacher = document.getElementById("newTeacherUsername").value;
      const newPass = document.getElementById("newTeacherPassword").value;
      const teachers = getTeachers();
      if (teachers[newTeacher]) {
        document.getElementById("loginResult").textContent = "すでに登録されています";
        return;
      }
      const hashed = await hashPassword(newPass);
      teachers[newTeacher] = hashed;
      saveTeachers(teachers);
      document.getElementById("loginResult").textContent = "先生登録完了";
    }

    async function teacherLogin() {
      const username = document.getElementById("teacherUsername").value;
      const password = document.getElementById("teacherPassword").value;
      const teachers = getTeachers();
      const hashed = await hashPassword(password);
      if (teachers[username] && teachers[username] === hashed) {
        localStorage.setItem("loggedInTeacher", username);
        showMainContent();
      } else {
        document.getElementById("loginResult").textContent = "ユーザー名またはパスワードが違います";
      }
    }

    function teacherLogout() {
      if (confirm("本当にログアウトしますか？")) {
        localStorage.removeItem("loggedInTeacher");
        document.getElementById("mainContent").style.display = "none";
        document.getElementById("settingsModal").style.display = "none";
        document.getElementById("loginScreen").style.display = "block";
      }
    }

    function showMainContent() {
      document.getElementById("loginScreen").style.display = "none";
      document.getElementById("mainContent").style.display = "block";
      // ログイン中のユーザー名表示
      const teacher = localStorage.getItem("loggedInTeacher");
      document.getElementById("loggedInTeacherDisplay").textContent = teacher ? `ログイン中: ${teacher}` : "";
      fetchAndDisplay(baserow.url, 'mainTable');
      fetchAndDisplay(baserow.lateurl, 'lateTable');
      fetchApproveTemplates(); // 承認タブ用データ取得
      // 欠席タブ用データ取得（最初に表示する場合に備えて）
      fetchAbsentStudents();
    }

    function showTab(tab) {
      document.getElementById('main').classList.remove('active');
      document.getElementById('late').classList.remove('active');
      document.getElementById('approve').classList.remove('active');
      document.getElementById('absent')?.classList.remove('active');
      document.getElementById('mainTab').classList.remove('active');
      document.getElementById('lateTab').classList.remove('active');
      document.getElementById('approveTab').classList.remove('active');
      document.getElementById('absentTab')?.classList.remove('active');
      document.getElementById(tab).classList.add('active');
      document.getElementById(tab + 'Tab').classList.add('active');
      // 承認タブを表示したときは最新を取得
      if (tab === 'approve') {
        fetchApproveTemplates();
      } else if (tab === 'absent') {
        fetchAbsentStudents();
      }
    }

    /**
     * 日付文字列/オブジェクトを解釈してタイムスタンプを返す（不正は NaN）
     * Baserow のフィールドがオブジェクトの場合も多少考慮
     */
    function parseDateValue(v) {
      if (!v) return NaN;
      if (typeof v === 'object') {
        // よくあるプロパティを試す
        const cand = v.value || v.date || v.start || v.toString();
        return new Date(cand).getTime();
      }
      return new Date(v).getTime();
    }

    function sortRowsByDateDesc(rows, field = 'Date') {
      return rows.sort((a, b) => {
        const ta = parseDateValue(a[field]);
        const tb = parseDateValue(b[field]);
        if (isNaN(ta) && isNaN(tb)) return 0;
        if (isNaN(ta)) return 1; // 日付が無いものは下に
        if (isNaN(tb)) return -1;
        return tb - ta; // 降順（新しいものを上）
      });
    }

    async function fetchAndDisplay(url, tableId, date = '', name = '') {
      let query = '?user_field_names=true';
      if (date) {
        query += `&filter__Date__equal=${date}`;
      }
      if (name) {
        query += `&filter__Name__equal=${name}`;
      }
      let res = await fetch(url + query, {
        method: 'GET',
        headers: {
          'Authorization': baserow.token,
          'Content-Type': 'application/json',
        },
      });
      let json = await res.json();
      let rows = json.results || [];

      // 日付で降順ソート
      rows = sortRowsByDateDesc(rows, 'Date');

      let tbody = document.querySelector(`#${tableId} tbody`);
      tbody.innerHTML = '';
      // 表のカラムに合わせて表示
      if (tableId === 'mainTable') {
        rows.forEach(row => {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.Date || ''}</td><td>${row.Number || ''}</td><td>${row.Name || ''}</td>`;
          tbody.appendChild(tr);
        });
      } else if (tableId === 'lateTable') {
        rows.forEach(row => {
          let tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.Date || ''}</td><td>${row.Number || ''}</td><td>${row.Name || ''}</td><td>${row.Reason || ''}</td>`;
          tbody.appendChild(tr);
        });
      }
    }

    // 承認テンプレート取得・表示（Nameの横に承認ボタンと削除ボタンを表示）
    async function fetchApproveTemplates() {
      const table = document.getElementById('approveTable');
      const thead = table.querySelector('thead');
      const tbody = table.querySelector('tbody');
      thead.innerHTML = '';
      tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">読み込み中...</td></tr>';

      try {
        const res = await fetch(baserow.templateurl + '?user_field_names=true', {
          method: 'GET',
          headers: {
            'Authorization': baserow.token,
            'Content-Type': 'application/json'
          }
        });
        const json = await res.json();
        let rows = json.results || [];

        // 日付で降順ソート
        rows = sortRowsByDateDesc(rows, 'Date');

        if (rows.length === 0) {
          thead.innerHTML = '';
          tbody.innerHTML = '<tr><td colspan="4" style="padding:12px">データがありません</td></tr>';
          return;
        }

        // ヘッダーを rows[0] のキーから動的に作る（idは非表示）
        const keys = Object.keys(rows[0]).filter(k => k !== 'id' && k !== 'order');
        const nameIndex = keys.indexOf('Name');
        const headerCells = [];
        keys.forEach((k, i) => {
          headerCells.push(`<th>${k}</th>`);
          if (i === nameIndex) headerCells.push(`<th>操作</th>`);
        });
        thead.innerHTML = '<tr>' + headerCells.join('') + '</tr>';

        tbody.innerHTML = '';
        rows.forEach(row => {
          const tr = document.createElement('tr');
          const cells = [];
          keys.forEach((k, i) => {
            const v = row[k];
            const text = (v && typeof v === 'object') ? JSON.stringify(v) : (v ?? '');
            cells.push(`<td>${text}</td>`);
            if (i === nameIndex) {
              cells.push(`<td data-approve-for="${row.id}"></td>`);
            }
          });

          tr.innerHTML = cells.join('');
          tbody.appendChild(tr);

          const buttonCell = tr.querySelector(`td[data-approve-for="${row.id}"]`);
          if (buttonCell) {
            // コンテナ作成（承認 + 削除）
            const container = document.createElement('div');
            container.style.display = 'flex';
            container.style.gap = '8px';
            container.style.justifyContent = 'center';

            // 承認ボタン
            const approveBtn = document.createElement('button');
            approveBtn.textContent = '承認';
            approveBtn.style.padding = '6px 10px';
            approveBtn.style.borderRadius = '6px';
            approveBtn.style.background = '#66bb6a';
            approveBtn.style.color = '#fff';
            approveBtn.style.border = 'none';
            approveBtn.style.cursor = 'pointer';
            approveBtn.style.minWidth = '64px';
            approveBtn.onclick = () => approveTemplate(row.id, row, approveBtn, keys);

            // 削除ボタン
            const deleteBtn = document.createElement('button');
            deleteBtn.textContent = '否認';
            deleteBtn.style.padding = '6px 10px';
            deleteBtn.style.borderRadius = '6px';
            deleteBtn.style.background = '#ef5350';
            deleteBtn.style.color = '#fff';
            deleteBtn.style.border = 'none';
            deleteBtn.style.cursor = 'pointer';
            deleteBtn.style.minWidth = '64px';
            deleteBtn.onclick = () => deleteTemplate(row.id, deleteBtn);

            container.appendChild(approveBtn);
            container.appendChild(deleteBtn);
            buttonCell.appendChild(container);
          }
        });
      } catch (e) {
        thead.innerHTML = '';
        tbody.innerHTML = `<tr><td colspan="4" style="padding:12px">取得エラー: ${e.message}</td></tr>`;
        console.error(e);
      }
    }

    // 承認処理：templateの行をlateテーブルに追加して、template側の行を削除する
    async function approveTemplate(rowId, rowData, btn, keys) {
      if (!confirm('このテンプレートを遅刻データに移動してよいですか？')) return;

      try {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '承認中...';

        // POST 用ペイロード作成（id/orderは除外）
        const payload = {};
        keys.forEach(k => {
          if (k === 'id' || k === 'order') return;
          payload[k] = rowData[k];
        });

        // 1) late テーブルへ追加
        const postRes = await fetch(baserow.lateurl + '?user_field_names=true', {
          method: 'POST',
          headers: {
            'Authorization': baserow.token,
            'Content-Type': 'application/json'
          },
          body: JSON.stringify(payload)
        });

        if (!postRes.ok) {
          const errText = await postRes.text();
          throw new Error('追加失敗: ' + postRes.status + ' ' + errText);
        }

        // 2) template の元行を削除
        const delRes = await fetch(baserow.templateurl + rowId + '/', {
          method: 'DELETE',
          headers: {
            'Authorization': baserow.token,
            'Content-Type': 'application/json'
          }
        });

        if (!delRes.ok) {
          const errText = await delRes.text();
          throw new Error('削除失敗: ' + delRes.status + ' ' + errText);
        }

        // UI 更新
        await fetchApproveTemplates();
        await fetchAndDisplay(baserow.lateurl, 'lateTable');
        alert('承認して移動しました。');
      } catch (e) {
        console.error(e);
        alert('承認エラー: ' + e.message);
        btn.disabled = false;
        btn.textContent = '承認';
      }
    }

    // 削除処理：templateテーブルの行を削除（復元不可）
    async function deleteTemplate(rowId, btn) {
      if (!confirm('このテンプレートを削除してよいですか？（復元できません）')) return;
      try {
        btn.disabled = true;
        const originalText = btn.textContent;
        btn.textContent = '削除中...';

        const delRes = await fetch(baserow.templateurl + rowId + '/', {
          method: 'DELETE',
          headers: {
            'Authorization': baserow.token,
            'Content-Type': 'application/json'
          }
        });

        if (!delRes.ok) {
          const errText = await delRes.text();
          throw new Error('削除失敗: ' + delRes.status + ' ' + errText);
        }

        await fetchApproveTemplates();
        alert('テンプレートを削除しました。');
      } catch (e) {
        console.error(e);
        alert('削除エラー: ' + e.message);
        btn.disabled = false;
        btn.textContent = '否認';
      }
    }

    function refreshApprove() {
      fetchApproveTemplates();
    }

    // 検索ボタン用
    async function mainSearch() {
      const date = document.getElementById('mainDate').value;
      const name = document.getElementById('mainName').value;
      await fetchAndDisplay(
        baserow.url,
        'mainTable',
        date ? new Date(date).toLocaleDateString() : '',
        name
      );
    }

    async function lateSearch() {
      const date = document.getElementById('lateDate').value;
      const name = document.getElementById('lateName').value;
      await fetchAndDisplay(
        baserow.lateurl,
        'lateTable',
        date ? new Date(date).toLocaleDateString() : '',
        name
      );
    }

    // 欠席判定：studenturl の Number から、本日 (baserow.url と baserow.lateurl の Date == 今日) に出現した Number を差し引いて表示
    async function fetchAbsentStudents() {
      const table = document.getElementById('studentTable');
      const tbody = table.querySelector('tbody');
      tbody.innerHTML = '<tr><td colspan="2" style="padding:12px">読み込み中...</td></tr>';
      try {
        const today = new Date().toLocaleDateString(); // 既存コードと同じフォーマットを使用

        // 今日の main と late の Number を取得
        const [mainRes, lateRes] = await Promise.all([
          fetch(baserow.url + '?user_field_names=true&filter__Date__equal=' + encodeURIComponent(today), { headers: { 'Authorization': baserow.token } }),
          fetch(baserow.lateurl + '?user_field_names=true&filter__Date__equal=' + encodeURIComponent(today), { headers: { 'Authorization': baserow.token } })
        ]);
        const mainJson = await mainRes.json();
        const lateJson = await lateRes.json();
        const todaysNumbers = new Set();
        (mainJson.results || []).forEach(r => { if (r.Number != null) todaysNumbers.add(String(r.Number)); });
        (lateJson.results || []).forEach(r => { if (r.Number != null) todaysNumbers.add(String(r.Number)); });

        // 全 student を取得して、今日出ている番号を除外
        const stuRes = await fetch(baserow.studenturl + '?user_field_names=true', { headers: { 'Authorization': baserow.token } });
        const stuJson = await stuRes.json();
        let rows = stuJson.results || [];
        rows = rows.filter(r => !todaysNumbers.has(String(r.Number)));

        // Number 降順で表示
        rows.sort((a, b) => {
          const na = Number(a.Number);
          const nb = Number(b.Number);
          if (isNaN(na) && isNaN(nb)) return 0;
          if (isNaN(na)) return 1;
          if (isNaN(nb)) return -1;
          return nb - na;
        });

        if (rows.length === 0) {
          tbody.innerHTML = '<tr><td colspan="2" style="padding:12px">欠席者はいません</td></tr>';
          return;
        }
        tbody.innerHTML = '';
        rows.forEach(row => {
          const tr = document.createElement('tr');
          tr.innerHTML = `<td>${row.Number ?? ''}</td><td>${row.Student ?? ''}</td>`;
          tbody.appendChild(tr);
        });
      } catch (e) {
        tbody.innerHTML = `<tr><td colspan="2" style="padding:12px">取得エラー: ${e.message}</td></tr>`;
        console.error(e);
      }
    }

    async function studentSearch() {
      const number = document.getElementById('absentDate').value; // 既存UIを流用しているため input id は absentDate のまま
      const student = document.getElementById('absentName').value;
      await fetchStudents(number ? new Date(number).toLocaleDateString() : number, student);
    }

    // 設定モーダル表示・非表示
    function openSettings() {
      document.getElementById("settingsModal").style.display = "flex";
    }

    function closeSettings() {
      document.getElementById("settingsModal").style.display = "none";
    }

    // ページロード時ログイン状態確認
    window.onload = function() {
      const teacher = localStorage.getItem("loggedInTeacher");
      if (teacher) {
        showMainContent();
      }
    }
  </script>
</body>

</html>